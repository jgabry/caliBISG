---
title: "caliBISG R package demo"
author: ""
date: "Last updated: `r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "")
```

## Intro

Bayesian Improved Surname Geocoding (BISG) is a ubiquitous tool for predicting
race and ethnicity using an individualâ€™s geolocation and surname, however
statistical dependence of surname and geolocation within racial/ethnic
categories in the United States results in biases for minority subpopulations.
Based on the method proposed by Greengard and Gelman (2025), we augment the data
used by traditional BISG (distributions of race by geolocation and race by
surname) with the distribution of surname by geolocation obtained from state
voter files. We then use a raking-based algorithm to compute calibrated BISG
(caliBISG) predictions. caliBISG is easily interpretable, more accurate, and
better calibrated than traditional BISG.

The `caliBISG` R package currently provides caliBISG using 2020 data for states
FL, GA, NC, NY, OH, OK, VT, WA. In addition to caliBISG, the package provides
traditional BISG for comparison. Traditional BISG is available for all fifty
states.

```{r setup-load-pacakge}
library(caliBISG)
```

## Download caliBISG data

(NOTE: In the future, we will download these files from Harvard Dataverse. For
now, in order to demonstrate what the user experience will look like, the
`download_data()` function is pretending to download them but is actually
reading them from a folder on my computer.)


```{r setup-delete_all_data, echo=FALSE, message=FALSE}
delete_all_data()
```

The `download_data()` function downloads the caliBISG data files for the
specified states and years (currently only 2020 is available). The data is
stored in an internal directory specific to the package (see
`?tools::R_user_dir`). By default `download_data()` will download all available
data, but here we download just the states VT and WA for demonstration. No
downloads are required for traditional BISG, which is computed by the package
when requested.

```{r download_data}
download_data(states = c("VT", "WA"), years = 2020) 
```

If the user just wants to use the package's convenience functions they never
need to load these data files manually after downloading them. However, if the
user wants to work directly with the large caliBISG files instead of using the
package's convenience functions they can load the data themselves with
`load_data()`.

```{r load_data}
vt_2020_data <- load_data("VT", 2020)
nrow(vt_2020_data)
colnames(vt_2020_data)
```

#### Convenience functions for managing data

The `data_dir()` function returns the path to the internal data storage
directory.

```{r data_dir}
data_dir()
```

The `available_data()` function lists the files the user has already downloaded
that are available for use. 

```{r available_data}
available_data()
```

The `delete_all_data()` function deletes all the files in the internal data
storage directory. 

```{r delete_all_data}
delete_all_data()
```

```{r download_data-2, echo=FALSE, message=FALSE, warning=FALSE}
download_data(states = c("VT", "WA"), years = 2020)
```

## Most probable race given surname and geolocation

The `most_probable_race()` function provides the single most probable race
according to caliBISG and traditional BISG. 

```{r most_probable_race}
most_probable_race(name = "smith", state = "WA", county = "king")
```

In this case the most probable race is Non-Hispanic White according to both
methods. The `in_census` column indicates whether the surname is found in the
list of names that appear at least 100 times in the census.

The returned object is a standard data frame with the number of rows equal to
the length of the input vectors. For example, when inputting two cases the 
resulting data frame has two rows. 

```{r most_probable_race-multiple-inputs}
most_probable_race(
  name = c("smith", "lopez"), 
  state = c("WA", "WA"), 
  county = c("king", "king")
)
```

If the the requested name/state/county combination is not one for which we have
a caliBISG prediction the `calibisg_race` column will contain an `NA` and a
warning will be thrown. As long as the state and county are valid we still
provide a traditional BISG estimate in the `bisg_race` column. If the county 
is not valid then both `calibisg_race` and `bisg_race` will be `NA`.

```{r most_probable_race-NA}
most_probable_race("smith", "wa", "not_a_county")
```

The `most_probable_race()` function also takes a `year` argument, but currently
only 2020 is available. 

## Probabilities for all races given surname and geolocation

The `race_probabilities()` function gives the caliBISG and BISG estimates for
the probability of each race. The returned object is a standard data frame, 
however it has a subclass `"compare_bisg"` and a custom print method that 
prints the results as tables comparing caliBISG and BISG. 

```{r race_probabilities}
probs <- race_probabilities(
  name = c("smith", "lopez", "chen"), 
  state = c("WA", "VT", "VT"), 
  county = c("king", "chittenden", "windsor")
)
str(probs)
print(probs)
```

The `digits` and `max_print` arguments to the `print()` method can be used to
change the number of digits printed and the maximum number of tables to print.

```{r print-digits-max_print}
print(probs, digits = 4, max_print = 2)
```

The defaults for an entire R session can be changed using
`options(calibisg.digits = ...)` and `options(calibisg.max_print = ...)`.


## References

Philip Greengard and Andrew Gelman (2025). A calibrated BISG for inferring race
from surname and geolocation.
*Journal of the Royal Statistical Society Series A: Statistics in Society*.
https://doi.org/10.1093/jrsssa/qnaf003.

