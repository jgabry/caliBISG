---
title: "caliBISG demo"
author: ""
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "")
```



```{r, echo=FALSE, message=FALSE}
library(caliBISG)
delete_all_data()
```

## Download data

In the future, we will actually download these files from the internet (once we
decide where to host the files). For now, in order to demonstrate what the user
experience will look like, the `download_data()` function is pretending to
download them (the URL in the console output is fake) but is actually reading
them from a folder on my computer.

```{r}
download_data(states = c("NC", "WA"), years = 2020) 
```

If the user just wants to use the package's convenience functions they never
need to load these data files manually after downloading them. However, if the
user wants to work directly with the large files instead of using the package's
convenience functions they can load the data themselves with `load_data()`.

```{r}
nc_2020_data <- load_data("NC")
nrow(nc_2020_data)
```

Currently only 2020 data can be downloaded but eventually multiple years will be
available.

#### Convenience functions for managing data

The `data_dir()` function returns the path to the internal data storage
directory.

```{r}
data_dir()
```

The `available_data()` function lists the files the user has already downloaded
that are available for them to query. 

```{r}
available_data()
```

The `delete_all_data()` function deletes all the files in the internal data
storage directory. 

```{r}
delete_all_data()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
download_data(states = c("NC", "WA"), years = 2020)
```

## Predict the most probable race based on surname and geolocation

The `most_probable_race()` function provides the single most probable race
according to the raking-based caliBISG approach from Greengard and Gelman (2024).

```{r}
most_probable_race(name = "smith", state = "WA", county = "king")
```

The returned object is a standard data frame with the number of rows equal to
the length of the input vectors. In this case the most probable race is
Non-Hispanic White. The `in_census` column indicates whether the surname is
found in the census.

```{r}
most_probable_race(
  name = c("smith", "lopez"), 
  state = c("WA", "WA"), 
  county = c("king", "king")
)
```

If the the name/state/county combination that the user requests is not one for
which we have a prediction the `race` column will contain an `NA` and a warning
will be thrown.

```{r}
most_probable_race("smith", "wa", "not_a_county")
```

The `most_probable_race()` function also takes a `year` argument but currently
only 2020 is available. 

## Get probabilities for all races based on surname and geolocation

The `race_probabilities()` function gives the caliBISG estimates for the
probabilities of all the races. Again, the object returned is just a standard
data frame, but the columns are the probabilities for each race, computed
using the raking-based approach to BISG from Greengard and Gelman (2024).

```{r}
lopez_nc_burke_probs <- race_probabilities(
  name = c("smith", "lopez"), 
  state = c("WA", "NC"), 
  county = c("king", "burke")
)
str(lopez_nc_burke_probs)
```

Similar to `most_probable_race()`, if the name/state/county combination is not
found an `NA` is returned for all the probabilities and a warning is thrown. 

```{r}
race_probabilities("lopez", "nc", "not_a_county")
```


## Compare raking-based caliBISG to traditional BISG 

The `compare_race_probabilities()` function allows the user to compare the
raking-based caliBISG probabilities from Greengard and Gelman (2024) to the
traditional BISG probabilities.

```{r}
comp1 <- compare_race_probabilities("lopez", "nc", "burke")
str(comp1)
```

The object returned is again a standard data frame, however there are additional
columns prefixed with `bisg_` (traditional BISG). The
`bisg_` and `calibisg_` columns are also interleaved, i.e., ordered
to place the races next to each other for easier comparison.

The `compare_race_probabilities()` function can also take vectors as inputs
and the resulting data frame will have number of rows equal to the lengths of
the vectors. 

```{r}
comp2 <- compare_race_probabilities(
  name = c("lopez", "jackson"), 
  state = c("wa", "nc"), 
  county = c("king", "burke")
)
str(comp2)
```

If the user has a small number of comparisons they can use
`print_comparison_tables()` to print nice tables in the console.

```{r}
print_comparison_tables(comp2)
```

## References

Philip Greengard and Andrew Gelman (2024). An improved BISG for inferring race
from surname and geolocation. https://arxiv.org/abs/2304.09126.

