---
title: "PISG demo"
author: ""
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "")
```



```{r, echo=FALSE, message=FALSE}
library(pisg)
delete_all_data()
```

## Download data

In the future, we will actually download these files from the internet (once we
decide where to host the files). For now, in order to demonstrate what the user
experience will look like, the `download_data()` function is pretending to
download them (the URL in the console output is fake) but is actually reading
them from a folder on my computer.

```{r}
download_data(states = c("NC", "WA"), years = 2020) 
```

If the user wants to work directly with the large files instead of using the
package's convenience functions they can load the data themselves. 

```{r}
nc_2020_data <- load_data("NC")
nrow(nc_2020_data)
```
If the user just wants to use the package's convenience functions they never 
need to call `load_data()`, but I assume some users will want the option to 
access the files directly. 

Right now only 2020 is available but eventually we can let the user specify
which years they want to download/load. 

#### Convenience functions for managing data

I've also added a few data-related convenience functions. 

The `data_dir()` function returns the path to the internal data storage directory:

```{r}
data_dir()
```

The `available_data()` function lists the files the user has already downloaded
that are available for them to query:

```{r}
available_data()
```

The `delete_all_data()` function deletes all the files in the internal data
storage directory:

```{r}
delete_all_data()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
download_data(states = c("NC", "WA"), years = 2020)
```

## Predict most probable race

The `most_probable_race()` function provides the single most probable race
according to PISG.

```{r}
most_probable_race(name = "smith", state = "WA", county = "king")
```
The returned object is just a standard data frame: 

```{r}
smith_wa_king <- most_probable_race("smith", "wa", "king")
str(smith_wa_king)
```

If the the name/state/county combination that the user requests is not found
we return `NA` for the `race` column with a warning. 

```{r}
most_probable_race("smith", "wa", "not_a_county")
```

**Does this seem like the right behavior or do you prefer an error in this case?**

The `most_probable_race()` function also takes a `year` argument but right now
only 2020 is available, so we default to using 2020.

## Get probabilities for all races

The `race_probabilities()` function gives the PISG estimates for the
probabilities of all the races. Again, the object returned is just a standard
data frame:

```{r}
lopez_nc_burke_probs <- race_probabilities("lopez", "nc", "burke")
str(lopez_nc_burke_probs)
```

**What should we name these columns?** Right now the names (e.g., `rake_nh_white`)
are the column names Philip gave me, but we can name them whatever we want in
the R package.

Similar to `most_probable_race()`, if the name/state/county combination is not
found we return `NA` for all the probabilities with a warning: 

```{r}
race_probabilities("lopez", "nc", "not_a_county")
```

**Same question as before: do you like that or do you prefer an error?**


## Compare raking-based BISG to "improved BISG"

The files I have contain PISG and improved BISG estimates but not traditional
BISG estimates, so for now we can compare those estimates:

```{r}
comp1 <- compare_race_probabilities("lopez", "nc", "burke")
str(comp1)
```

This just returns a data frame with `bisg` columns and `rake` columns, but the
columns are interleaved, i.e., ordered to place the races next to each other for
easier comparison. **Do you like returning a data frame like this? Other ideas?**

#### Multiple comparisons 

The `compare_race_probabilities()` function can also now take vectors as inputs
and the resulting data frame will have number of rows equal to the lengths of
the vectors:

```{r}
comp2 <- compare_race_probabilities(
  name = c("lopez", "jackson"), 
  state = c("wa", "nc"), 
  county = c("king", "burke")
)
str(comp2)
```

#### Printing comparison tables 

Also new is that, instead of automatically printing the formatted comparison
tables, the user now needs to call a new function `print_comparison_tables()`.
This is because if the user asks for a comparison of many names, states, and
counties, too much would be printed in the console. So now if the user has a
small number of comparisons they can call `print_comparison_tables()` and it
will print one table per row of the data frame:

```{r}
print_comparison_tables(comp2)
```
